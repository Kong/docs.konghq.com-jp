---
title: "Kong Enterprise LTS 2.8 から 3.4 へのアップグレードガイド"
badge: "enterprise"
---

{{site.base_gateway}}は、 {{site.ee_product_name}}の長期サポート（LTS）バージョン間の直接アップグレードをサポートします。

このガイドでは、{{site.ee_product_name}} 2\.8 LTSから{{site.ee_product_name}} 3\.4 LTSへのアップグレードについて、
特に2\.8\.0\.0\-2\.8\.4\.1から3\.4\.0\.0までをカバーして説明します。
各エントリを慎重に確認し、それに応じて構成を変更します。

LTSのアップグレードには3つのアップグレードストラテジがあります。
このガイドでは、 {{site.base_gateway}}がサポートする各デプロイメントモードに最適な戦略を指定します。
さらに、アップグレードプロセスで重要な役割を果たすいくつかの基本的な要素をリストアップし、データのバックアップと復元の方法について説明します。

このガイドでは、{{site.base_gateway}}のコンテキスト内で次の用語を使用します。

* **アップグレード** ：{{site.base_gateway}}の古いバージョンから新しいバージョンに切り替える全体的なプロセスです。
* **移行** : データストアのデータを新しい環境に移行します。 たとえば、2\.8のデータを古いPostgreSQLインスタンスから3\.4の新しいインスタンスに移動するプロセスは、データベース移行と呼ばれます。

アップグレードを確実に成功させるには、このガイドのすべての手順をよくお読みください。すべての準備手順を理解することと、デプロイメントタイプに基づき推奨アップグレードパスを選択することが非常に重要です。

{:.important}
> 
> **注意** : このドキュメントで説明されている移行パターンは、{{site.ee_product_name}} 2\.8 LTSと{{site.ee_product_name}} 3\.4 LTS間の2つのLTSバージョンでのみ発生します。このドキュメントを他のリリース間隔に適用すると、データベースの変更が誤った順序で実行され、データベーススキーマが壊れた状態になる可能性があります。他のバージョン間で移行するには、[一般的なアップグレードガイド](/gateway/{{page.release}}/upgrade/)を参照してください。

前提条件
----

* 3\.4以降では、Cassandraはサポートされていません。 Cassandraをデータストアとして使用している場合は、まず[Cassandraの移行](/gateway/{{page.release}}/migrate-cassandra-to-postgres/)を行い、その後、アップグレードを行います。
* プラットフォームのバージョンとアップグレード先の{{site.kong_gateway}}のバージョン間のバージョン互換性を確認します。 
  * [OSバージョン](/gateway/{{page.release}}/support-policy/#supported-versions)
  * [KubernetesバージョンとHelmの前提条件](/kubernetes-ingress-controller/latest/support-policy/)
  {% if_version gte:3.2.x -%}
  * [データベースのバージョン](/gateway/{{page.release}}/support/third-party/)
  * [依存関係のバージョン](/gateway/{{page.release}}/support/third-party/) {% endif_version %}

* [KICアップグレードの互換性を確認します](/kubernetes-ingress-controller/latest/guides/upgrade-kong-3x/)。
* decKを使用している場合は、[最新バージョンにアップグレードします](/deck/latest/installation/)。

このドキュメントにはアップグレードに必要なすべての操作知識が記載されているため、このドキュメントをよくお読みになり、アップグレードプロセスを正常に完了してください。

アップグレード手順の概要
------------

**準備フェーズ** 

{{site.base_gateway}} 3\.4LTS にアップグレードする前に、いくつかの手順を完了させる必要があります。

1. リストされている前提条件をすべて実行します。
2. データベースまたは宣言型構成ファイルを[バックアップ](#preparation-choose-a-backup-strategy)します。
3. お客様のデプロイメントトポロジーに基づいて、適切な[アップグレードストラテジ](#preparation-choose-an-upgrade-strategy-based-on-deployment-mode)を選択します。
4. デプロイメントに影響する下位互換性のない変更がないか、[2\.8から3\.4への{{site.base_gateway}}の変更](#preparation-review-gateway-changes)を確認してください。
5. LTSリリース間で[`kong.conf`ファイルに加えられた変更](#kongconf-changes)を徹底的に調べます。
6. 選択したストラテジを使用して、運用前環境で移行をテストします。

**アップグレードの実行** 

実際の以降の実行は、{{site.base_gateway}}でのデプロイメントのタイプによって異なります。
アップグレードプロセスのこの部分では、準備フェーズで決定したストラテジを使用します。

1. 選択したアップグレードストラテジをdev上で実行します。
2. devからprodに移行します。
3. スモークテスト。
4. アップグレードを終了するか、ロールバックして再試行します。

それでは、バックアップオプションから始めて準備に移りましょう。

準備：バックアップストラテジを選択する
-------------------

{% include_cached /md/gateway/upgrade-backup.md release=page.release %}

準備：デプロイメントモードに基づいてアップグレードストラテジを選択する
-----------------------------------

このセクションで紹介するアップグレードストラテジは一般的なものであり、実際のデプロイメント環境によっては適合しない場合があります。

以下のデプロイメントモードを選択します。

* [従来モード](#traditional-mode)
* [DBレスモード](#db-less-mode)
* [ハイブリッドモード](#hybrid-mode)

意思決定プロセスがどのように機能するかを詳しく説明したフローチャートを以下に示します。

{% include_cached md/gateway/upgrade-flow.md %}

各ストラテジの詳細については、次のセクションを参照してください。

### 従来モード

{% include_cached /md/gateway/traditional-upgrade.md %}

#### デュアルクラスターのアップグレード

[デュアルクラスタのアップグレードストラテジ](/gateway/{{page.release}}/upgrade/dual-cluster/)を使用すると、ダウンタイムなしで{{site.base_gateway}}をあるLTSバージョンから別のLTSバージョンにアップグレードできます。
このアプローチでは、アップグレードされたバージョンの{{site.base_gateway}}を実行する新しいクラスタを、現在のバージョンを実行している既存のクラスタと一緒にセットアップします。

高いレベルで、一般的にこのプロセスには以下の手順が含まれます。

1. **同じ規模のデプロイメントのプロビジョニング** ：アップグレードされた {{site.base_gateway}} を実行する新しいクラスタの容量とリソースが、既存のクラスタと同じであるか確認する必要があります。これにより、両方のクラスタが同じ量のトラフィックとワークロードを処理できるようになります。

2. **デュアルクラスタデプロイメントの設定** ：新しいクラスタがプロビジョニングされたら、APIと構成を両方のクラスタに同時に展開できます。デュアルクラスタデプロイメントでは、古いクラスタと新しいクラスタの両方を共存させ、リクエストを並行して処理できます。

3. **データ同期** ：デュアルクラスタ展開では、両方のクラスタに同じデータがあることを確認するため、データ同期が不可欠です。これには、古いクラスタから新しいクラスタへのデータの移行や、両方のクラスタの同期を維持するための共有データストレージソリューションの設定が含まれます。スナップショットまたは `pg_restore` を使用して、古いクラスタから新しいクラスタにデータベースをインポートします。

4. **トラフィックの再ルーティング** ：新しいクラスタは古いクラスタと並行して実行されているので、受信トラフィックを徐々に新しいクラスタにルーティングし始めることができます。このプロセスは、ユーザーへの影響を最小限に抑えるため、段階的に実行することも、制御された切り替えメカニズムを通じて実行することもできます。これは、DNS、Nginx、F5、またはCanaryプラグインが有効になっている {{site.base_gateway}} ノードなど、どのロードバランサーでも実現できます。

5. **テストと検証** ：新しいクラスタへの完全な切り替えを行う前に、アップグレードされたバージョンの機能を徹底的にテストして検証することが不可欠です。これには、API、プラグイン、認証メカニズム、その他の機能性が期待通りに動作することを確認するためのテストが含まれます。

6. **完全な切り替え** ：アップグレードしたクラスタが完全に機能し安定していることが確認できたら、すべての受信トラフィックを新しいクラスタにリダイレクトできます。この手順により、アップグレードプロセスが完了し、古いクラスタが廃止されます。

このデュアルクラスタのデプロイストラテジに従うことで、{{site.base_gateway}}をあるLTSバージョンから別のLTSバージョンに、スムーズでダウンタイムなしにアップグレードできます。このアプローチにより、アップグレードプロセス全体を通じて、ユーザーに対する高可用性と中断のないサービスが保証されます。

#### インプレースアップグレード

[インプレースアップグレード](/gateway/{{page.release}}/upgrade/in-place/)では、同じインフラ上でアップグレードを実行できますが、
実際のアップグレードプロセスでは、ある程度のダウンタイムが必要です。
アップグレードを実行できる、適切なメンテナンスまたはダウンタイムウィンドウを計画します。
この間、{{site.base_gateway}}は一時的に利用できなくなります。

ダウンタイムなしで行う必要があるシナリオでは、[デュアルクラスタアップグレード](#dual-cluster-upgrade)を検討し、
追加のリソースと複雑さに注意してください。

### DB\-lessモード

{% include_cached /md/gateway/db-less-upgrade.md release=page.release %}

### ハイブリッドモード

{% include_cached /md/gateway/hybrid-upgrade.md release=page.release %}

準備：ゲートウェイの変更を見直す
----------------

次の表は、{{site.ee_product_name}} 2\.8\.0\.0\-2\.8\.4\.1から3\.4\.0\.0までのすべての関連する変更ログエントリを分類したものです。
各エントリを慎重に確認し、それに応じて構成を変更します。

{% include_cached lts-changes.html %}

### kong.confの変更

|                   2\.8                    |                                                            3\.4                                                            |
|--------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------|
| `data_plane_config_cache_mode` = 暗号化されていない | 3\.4で削除                                                                                                                    |
| `data_plane_config_cache_path`             | 3\.4で削除                                                                                                                    |
| `admin_api_uri`                            | 非推奨。代わりに`admin_gui_api_url`を使用します                                                                                           |
| `database`                                 | 使用可能な値は、`postgres` と `off` です。Cassandraオプションはすべて削除されました                                                                     |
| `pg_keepalive_timeout = 60000`             | プール内のPostgres接続の最大アイドルタイムアウト（ミリ秒単位）を指定します。この値を0に設定すると、タイムアウト間隔は無制限になります。指定しない場合、この値は`lua_socket_keepalive_timeout`と同じになります。 |
| `worker_consistency = strict`              | `worker_consistency = eventual`                                                                                             |
| `prometheus_plugin_*`                      | Prometheusプラグインの高カーディナリティメトリクスを無効にしました。                                                                                     |
| `lua_ssl_trusted_certificate` <br>デフォルト値なし | デフォルト値: `lua_ssl_trusted_certificate = system`                                                                              |
| `pg_ssl_version = tlsv1`                   | `pg_ssl_version = tlsv1_2`                                                                                                  |
| \-\-                                     | `allow_debug_header = off` （新しいパラメータ）                                                                                       |

アップグレードの実行
----------

アップグレードストラテジを選択し、2\.8と3\.4 LTSリリース間の関連する変更をすべて確認しました。
選択したストラテジでアップグレードを実行できます。

従来モードまたはハイブリッドモードのコントロールプレーン:

* [デュアルクラスターのアップグレード](/gateway/{{page.release}}/upgrade/dual-cluster/)
* [インプレースアップグレード](/gateway/{{page.release}}/upgrade/in-place/)

DB\-lessモードまたはハイブリッドモードのデータプレーン:

* [ローリングアップグレード](/gateway/{{page.release}}/upgrade/rolling-upgrade/)

トラブルシューティング
-----------

アップグレード中に問題が発生し、ロールバックする必要がある場合は、バックアップ方法に基づいて[{{site.base_gateway}}を復元](/gateway/{{page.release}}/upgrade/backup-and-restore/#restore-gateway-entities)します。

