---
##
#  WARNING: this file was auto-generated by a script.
#  DO NOT edit this file directly. Instead, send a pull request to change
#  https://github.com/Kong/kong/tree/master/kong/pdk
#  or its associated files
##

title: "kong.client"
pdk: true
toc: true
source_url: "https://github.com/Kong/kong/tree/master/kong/pdk/client.lua"
---
クライアント情報モジュール。

特定のリクエストのコンテキストでKongに接続しているクライアントに関する情報を取得するための関数のセット。

ほかの参照リソース：[nginx.org/en/docs/http/ngx\_http\_realip\_module.html](http://nginx.org/en/docs/http/ngx_http_realip_module.html)

kong.client.get\_ip\(\)
--------------------------

リクエストを行っているクライアントのリモートアドレスを返します。このモジュールは
**常に** Kongに直接接続しているクライアントのアドレスを返します。つまり、
ロードバランサーがKongの前にある場合、この関数はダウンストリームの
クライアントのアドレス **ではなく** 、ロードバランサーのアドレスを返します。

**フェーズ** 

* certificate, rewrite, access, header\_filter, response, body\_filter, log

**戻り値** 

* `string`: リクエストを行っているクライアントのリモートIPアドレス。

**使用方法** 

```lua
-- Given a client with IP 127.0.0.1 making connection through
-- a load balancer with IP 10.0.0.1 to Kong answering the request for
-- https://example.com:1234/v1/movies
kong.client.get_ip() -- "10.0.0.1"
```

kong.client.get\_forwarded\_ip\(\)
--------------------------------------

リクエストを行っているクライアントのリモートアドレスを返します。`kong.client.get_ip`
とは異なり、この関数は、ロードバランサーがKongの前にある場合に転送されたアドレスを考慮します。
この関数が転送されたアドレスを返すかどうかは、以下のKong構成パラメータに応じて決まります。

* [trusted\_ips](https://docs.konghq.com/gateway/latest/reference/configuration/#trusted_ips)
* [real\_ip\_header](https://docs.konghq.com/gateway/latest/reference/configuration/#real_ip_header)
* [real\_ip\_recursive](https://docs.konghq.com/gateway/latest/reference/configuration/#real_ip_recursive)

**フェーズ** 

* certificate, rewrite, access, header\_filter, response, body\_filter, log

**戻り値** 

* `string`：転送されたアドレスを考慮して、リクエストを行っているクライアントの リモートIPアドレス。

**使用方法** 

```lua
-- Given a client with IP 127.0.0.1 making connection through
-- a load balancer with IP 10.0.0.1 to Kong answering the request for
-- https://username:password@example.com:1234/v1/movies

kong.client.get_forwarded_ip() -- "127.0.0.1"

-- Note: This example assumes that 10.0.0.1 is one of the trusted IPs, and that
-- the load balancer adds the right headers matching with the configuration
-- of `real_ip_header`, e.g. `proxy_protocol`.
```

kong.client.get\_port\(\)
----------------------------

リクエストを行っているクライアントのリモートポートを返します。これは
**常に** Kongに直接接続しているクライアントのポートを返します。つまり、
ロードバランサーがKongの前にある場合、この関数はダウンストリームの
クライアントのポート **ではなく** 、ロードバランサーのポートを返します。

**フェーズ** 

* certificate, rewrite, access, header\_filter, response, body\_filter, log

**戻り値** 

* `number`：リモートクライアントのポート。

**使用方法** 

```lua
-- [client]:40000 <-> 80:[balancer]:30000 <-> 80:[kong]:20000 <-> 80:[service]
kong.client.get_port() -- 30000
```

kong.client.get\_forwarded\_port\(\)
----------------------------------------

リクエストを行っているクライアントのリモートポートを返します。`kong.client.get_port`とは異なり、この関数は、ロードバランサーがKongの前にある場合に転送されたポートを考慮します。この関数が転送されたポートを返すかどうかは、以下のKong構成パラメータに応じて決まります。

* [trusted\_ips](https://docs.konghq.com/gateway/latest/reference/configuration/#trusted_ips)
* [real\_ip\_header](https://docs.konghq.com/gateway/latest/reference/configuration/#real_ip_header)
* [real\_ip\_recursive](https://docs.konghq.com/gateway/latest/reference/configuration/#real_ip_recursive)

**フェーズ** 

* certificate, rewrite, access, header\_filter, response, body\_filter, log

**戻り値** 

* `number`: 転送されたポートを考慮したリモートクライアントポート。

**使用方法** 

```lua
-- [client]:40000 <-> 80:[balancer]:30000 <-> 80:[kong]:20000 <-> 80:[service]
kong.client.get_forwarded_port() -- 40000

-- Note: This example assumes that [balancer] is one of the trusted IPs, and that
-- the load balancer adds the right headers matching with the configuration
-- of `real_ip_header`, e.g. `proxy_protocol`.
```

kong.client.get\_credential\(\)
----------------------------------

現在認証されているコンシューマの認証情報を返します。設定されていない場合は、`nil`を返します。

**フェーズ** 

* access、header\_filter、response、body\_filter、log

**戻り値** 

* `string`: 認証された認証情報。

**使用方法** 

```lua
local credential = kong.client.get_credential()
if credential then
  consumer_id = credential.consumer_id
else
  -- request not authenticated yet
end
```

kong.client.load\_consumer\(consumer\_id\[, search\_by\_username\]\)
--------------------------------------------------------------------------

データストアからコンシューマを返します。IDでコンシューマを検索し、オプションで名前による2番目の検索を実行することもできます。

**フェーズ** 

* access、header\_filter、response、body\_filter、log

**パラメータ** 

* **consumer\_id** \(`string`\): 検索するコンシューマ ID
* **search\_by\_username** \(`boolean`、 *オプション* \): 真実かつ、 IDでコンシューマが見つからない場合、 ユーザー名による2回目の検索が実行されます。

**戻り値** 

1. `table|nil`：コンシューマエンティティまたは `nil`。

2. `nil|err`：成功した場合は`nil`、失敗した場合はエラーメッセージ。

**使用方法** 

```lua
local consumer_id = "john_doe"
local consumer = kong.client.load_consumer(consumer_id, true)
```

kong.client.get\_consumer\(\)
--------------------------------

現在認証されているコンシューマの `consumer` エンティティを返します。
設定されていない場合は、`nil` を返します。

**フェーズ** 

* access、header\_filter、response、body\_filter、log

**戻り値** 

* `table`: 認証されたコンシューマエンティティ。

**使用方法** 

```lua
local consumer = kong.client.get_consumer()
if consumer then
  consumer_id = consumer.id
else
  -- request not authenticated yet, or a credential
  -- without a consumer (external auth)
end
```

kong.client.authenticate\(consumer, credential\)
--------------------------------------------------

{% if_version gte:3.4.x %}
認証されたコンシューマおよび/または認証情報、および現在のリクエストの認証済みコンシューマグループを設定します。`consumer`と`credential`はどちらも`nil`になる可能性がありますが、少なくともどちらかは存在する必要があります。それ以外の場合、この関数はエラーをスローします。{% endif_version %}

{% if_version lte:3.3.x %}
現在のリクエストの認証されたコンシューマおよび/または認証情報を設定します。

`consumer`と`credential`はどちらも`nil`
になる可能性がありますが、少なくともどちらかが必ず必要です。それ以外の場合、この関数はエラーをスローします。
{% endif_version %}

**フェーズ** 

* access

**パラメータ** 

* **consumer** （`table|nil`）: 設定するコンシューマー。値が指定されない場合、既存の値はすべて削除されます。
* **credential** （`table|nil`）: 設定する認証情報。値が指定されない場合、既存の値はすべて削除されます。

**使用方法** 

```lua
-- assuming `credential` and `consumer` have been set by some authentication code
kong.client.authenticate(consumer, credentials)
```

{% if_version gte:3.5.x %}

\_CLIENT.set\_authenticated\_consumer\_groups\(group\)
------------------------------------------------------------

現在のリクエストに対して認証されたコンシューマグループを明示的に設定します。
`group` が、テーブルでも `nil` でもない場合にはエラーを通知します。

**フェーズ** 

* auth\_and\_later

**パラメータ** 

* **グループ** （`table|nil`）：設定するコンシューマグループ。「いいえ」の値が指定された場合、既存の値はすべてクリアされます。この値は、各グループが `id`や`name`のようなグループのメタデータを含むテーブル。

**使用方法** 

```lua
-- assuming `group` is provided by some code
_CLIENT.set_authenticated_consumer_groups(group)
```

\_CLIENT.set\_authenticated\_consumer\_group\(group\)
-----------------------------------------------------------

この関数は非推奨となり、`set_authenticated_consumer_groups`が優先されるようになります。
現在のリクエストに対して認証されたコンシューマグループを明示的に設定します。
`group`がテーブルでも`nil`でもない場合は、エラーをスローします。

**フェーズ** 

* auth\_and\_later

**パラメータ** 

* **グループ** （`table|nil`）：設定するコンシューマグループ。「いいえ」の値が指定された場合、既存の値はすべてクリアされます。この値は、 `id`や`name`のようなグループのメタデータを含むテーブルである必要があります。

**使用方法** 

```lua
-- assuming `group` is provided by some code
_CLIENT.set_authenticated_consumer_group(group)
```

\_CLIENT.get\_consumer\_groups\(\)
---------------------------------------

現在のリクエストの認証済みコンシューマ グループを取得します。

**フェーズ** 

* auth\_and\_later

**戻り値** 

* `table|nil`: 認証されたコンシューマグループ。現在のリクエストに対してコンシューマグループが認証されていない場合は、`nil`を返します。

**使用方法** 

```lua
local groups = _CLIENT.get_consumer_groups()
```

{% endif_version %}

{% if_version gte:3.4.x %}

\_CLIENT.get\_consumer\_group\(\)
--------------------------------------

この関数は非推奨となり、`get_consumer_groups` が優先されるようになります。現在のリクエストに対する認証済みコンシューマグループを取得します。

**フェーズ** 

* auth\_and\_later

**戻り値** 

* `table|nil`：認証されたコンシューマグループ。ない場合は`nil`を返します 現在のリクエストに対してコンシューマ グループが認証されました。

**使用方法** 

```lua
local group = _CLIENT.get_consumer_group()
```

{% endif_version %}
{% if_version gte:3.5.x %}

\_CLIENT.authenticate\_consumer\_group\_by\_consumer\_id\(consumer\_id\)
---------------------------------------------------------------------------------

指定されたコンシューマ IDに基づいて、現在のリクエストのコンシューマグループを設定します。consumer\_idが文字列でもnilでもない場合は、エラーが返されます。コンシューマグループがすでに認証されている場合、グループは上書きされません。この関数は、cache\_keyのサブセットを使用して、redis\-SCAN のような検索を実行します。consumer\_group\_mappingは決定論的な動作のためにグループ名でソートされますが、これは将来のリリースで変更される可能性があります。

**フェーズ** 

* access

**パラメータ** 

* **consumer\_id** （`string|nil`）：コンシューマグループ向けのコンシューマID。 値が未指定の場合、現在のコンシューマグループは変更されません。

**使用方法** 

```lua
-- assuming `consumer_id` is provided by some code
_CLIENT.authenticate_consumer_group_by_consumer_id(consumer_id)
```

{% endif_version %}

kong.client.get\_protocol\(\[allow\_terminated\]\)
------------------------------------------------------

現在のルートに一致するプロトコルを返します（`"http"`、`"https"`、`"tcp"` または `"tls"`）。一致するルートがない場合は `nil` を返します。これは、リクエストが間違っている場合に起こり得ます。

**フェーズ** 

* access、header\_filter、response、body\_filter、log

**パラメータ** 

* **allow\_terminated** （`boolean`、 *任意* ）: 設定すると、HTTPSのチェック時に`X-Forwarded-Proto`ヘッダーがチェックされます。

**戻り値** 

1. `string|nil`: `"http"`、 `"https"`、 `"tcp"`、 `"tls"`、 `nil`のいずれかになります。

2. `nil|err`：成功した場合は`nil`、失敗した場合はエラーメッセージ。

**使用方法** 

```lua
kong.client.get_protocol() -- "http"
```

