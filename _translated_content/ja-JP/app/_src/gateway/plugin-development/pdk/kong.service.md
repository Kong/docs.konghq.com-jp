---
##
#  WARNING: this file was auto-generated by a script.
#  DO NOT edit this file directly. Instead, send a pull request to change
#  https://github.com/Kong/kong/tree/master/kong/pdk
#  or its associated files
##

title: "kong.service"
pdk: true
toc: true
source_url: "https://github.com/Kong/kong/tree/master/kong/pdk/service.lua"
---
サービスモジュールには、特定のホスト、IPアドレス/ポートへの接続、ロードバランシングとヘルスチェックのための特定のアップストリームエンティティの選択など、サービスへの要求の接続側面を操作する一連の関数が含まれています。

kong.service.set\_upstream\(host\)
-------------------------------------

このリクエストに対して、ロードバランシングの処理を担当する希望のアップストリームエンティティを設定します。
このメソッドを使用することは、
`host` プロパティがアップストリームエンティティと同等のサービスを作成することと同じです（この場合、
リクエストは、そのアップストリームに関連するターゲットの 1 つにプロキシされます
）。

`host`引数は、現在設定されているUpstreamエンティティの1つの名前と等しい文字列を受け取る必要があります。

**フェーズ** 

* access

**パラメータ** 

* **ホスト** （`string`）：

**戻り値** 

1. `boolean|nil`：`true`で成功、または見つかった場所にアップストリームエンティティがない場合は
   `nil`となります。

2. `string|nil`: エラーがあった場合、その内容を説明するエラーメッセージ。

**使用法** 

```lua
local ok, err = kong.service.set_upstream("service.prod")
if not ok then
  kong.log.err(err)
  return
end
```

kong.service.set\_target\(host, port\)
-----------------------------------------

リクエストをプロキシするために接続するホストとポートを設定します。
この方法を使用することは、Kongにこのリクエストでロードバランシングフェーズを
実行しないよう依頼するのに等しく、手書きで上書きされたとみなします。
再試行やヘルスチェックなどのロードバランシングコンポーネントも
このリクエストで無視されます。

`host` 引数にはアップストリームサーバーのホスト名または IP アドレスを指定し、`port` 引数にはポート番号を指定します。

**フェーズ** 

* access

**パラメータ** 

* **ホスト** （`string`）：
* **port** \(`number`\):

**使用法** 

```lua
kong.service.set_target("service.local", 443)
kong.service.set_target("192.168.130.1", 80)
```

kong.service.set\_tls\_cert\_key\(chain, key\)
---------------------------------------------------

サービスとのハンドシェイク中に使用されるクライアント証明書を設定します。

`chain`引数は、[ngx.ssl.parse\_pem\_cert](https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_pem_cert)などの関数によって返されるクライアント証明書と中間チェーン（存在する場合）です。

`key`引数は、[ngx.ssl.parse\_pem\_priv\_key](https://github.com/openresty/lua-resty-core/blob/master/lib/ngx/ssl.md#parse_pem_priv_key)などの関数によって返される、クライアント証明書に対応する秘密鍵です。

**フェーズ** 

{% if_version lte:3.2.x %}

* `rewrite`, `access`, `balancer` {% endif_version %}

{% if_version gte:3.3.x %}

* `rewrite`、`access`、`balancer`、`preread` {% endif_version %}

**パラメータ** 

* **チェーン** （`cdata`）: クライアント証明書チェーン
* **キー** （`cdata`）：クライアント証明書の秘密鍵

**戻り値** 

1. `boolean|nil`：操作が成功した場合は`true` 、エラーが発生した場合は`nil`。

2. `string|nil`: エラーがあった場合、その内容を説明するエラーメッセージ

**使用法** 

```lua
local chain = assert(ssl.parse_pem_cert(cert_data))
local key = assert(ssl.parse_pem_priv_key(key_data))

local ok, err = kong.service.set_tls_cert_key(chain, key)
if not ok then
  -- do something with error
end
```

kong.service.set\_tls\_verify\(on\)
---------------------------------------

サービスとのハンドシェイク中にTLS検証が有効かどうかを設定します。

`on`引数はブール型フラグです。`true`の場合、アップストリーム検証が有効であり、`false`の場合は無効です。

この呼び出しは、現在のリクエストのみに影響します。信頼された証明書ストアがまだ設定されていない場合（[proxy\_ssl\_trusted\_certificate](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_trusted_certificate)または[kong.service.set\_upstream\_ssl\_trusted\_store](#kongserviceset_upstream_ssl_trusted_store)経由）、TLS検証は常に「ローカル発行者証明書を取得できません」というエラーで失敗します。

**フェーズ** 

{% if_version lte:3.3.x %}

* `rewrite`, `access`, `balancer` {% endif_version %}

{% if_version gte:3.4.x %}

* `rewrite`、`access`、`balancer`、`preread` {% endif_version %}

**パラメータ** 

* **on** （`boolean`）：現在のリクエストにTLS証明書の検証を有効にするかどうか

**戻り値** 

1. `boolean|nil`：操作が成功した場合は`true` 、エラーが発生した場合は`nil`。

2. `string|nil`: エラーがあった場合、その内容を説明するエラーメッセージ

**使用法** 

```lua
local ok, err = kong.service.set_tls_verify(true)
if not ok then
  -- do something with error
end
```

kong.service.set\_tls\_verify\_depth\(depth\)
--------------------------------------------------

アップストリームサーバーのTLS証明書を検証する際の、検証の最大深度を設定します。

この呼び出しは、現在のリクエストのみに影響します。実際に使用する深さについては、検証
次のいずれかで有効にする必要があります [proxy\_ssl\_verify](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_verify)
ディレクティブを使用するか、 [kong.service.set\_tls\_verify](#kongserviceset_tls_verify)関数。

**フェーズ** 

{% if_version lte:3.2.x %}

* `rewrite`, `access`, `balancer` {% endif_version %}

{% if_version gte:3.3.x %}

* `rewrite`、`access`、`balancer`、`preread` {% endif_version %}

**パラメータ** 

* **depth** （`number`）：検証時に使用される深さ。値は負でない必要があります。

**戻り値** 

1. `boolean|nil`：操作が成功した場合は`true` 、エラーが発生した場合は`nil`。

2. `string|nil`: エラーがあった場合、その内容を説明するエラーメッセージ

**使用法** 

```lua
local ok, err = kong.service.set_tls_verify_depth(3)
if not ok then
  -- do something with error
end
```

kong.service.set\_tls\_verify\_store\(store\)
--------------------------------------------------

アップストリームサーバーのTLS証明書を検証するときに使用するCA信頼ストアを設定します。

この呼び出しは、現在のリクエストのみに影響します。実際に利用される店舗については、検証
次のいずれかで有効にする必要があります [proxy\_ssl\_verify](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_ssl_verify)
ディレクティブを使用するか、 [kong.service.set\_tls\_verify](#kongserviceset_tls_verify)関数。

resty.openssl.x509\.store オブジェクトは、Kong/lua\-Kong\-nginx\-moduleリポジトリの[例](https://github.com/Kong/lua-kong-nginx-module#restykongtlsset_upstream_ssl_trusted_store)に従って作成できます。

**フェーズ** 

{% if_version lte:3.2.x %}

* `rewrite`, `access`, `balancer` {% endif_version %}

{% if_version gte:3.3.x %}

* `rewrite`、`access`、`balancer`、`preread` {% endif_version %}

**パラメータ** 

* **store** （`table`）使用するresty.openssl.x509\.storeオブジェクト

**戻り値** 

1. `boolean|nil`：操作が成功した場合は`true` 、エラーが発生した場合は`nil`。

2. `string|nil`: エラーがあった場合、その内容を説明するエラーメッセージ

**使用法** 

```lua
local store = require("resty.openssl.x509.store")
local st = assert(store.new())
-- st:add(...certificate)

local ok, err = kong.service.set_tls_verify_store(st)
if not ok then
  -- do something with error
end
```

